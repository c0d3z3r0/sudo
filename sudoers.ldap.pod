=cut
Copyright (c) 2003-2008
	Todd C. Miller <Todd.Miller@courtesan.com>

Permission to use, copy, modify, and distribute this software for any
purpose with or without fee is hereby granted, provided that the above
copyright notice and this permission notice appear in all copies.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

$Sudo$
=pod

=head1 NAME

sudoers.ldap - sudo LDAP configuration

=head1 DESCRIPTION

In addition to the standard I<sudoers> file, B<sudo> may be configured
via LAP.  This can be especially useful for syncronizing I<sudoers>
in a large, distributed environment.

Using LDAP for I<sudoers> has several benefits:

=over 4

=item *

B<sudo> no longer needs to read I<sudoers> in its entirety.  Parsing
of F</etc/sudoers> requires the entire file to be read.  When LDAP
is used, there are only two or three LDAP queries per invocation.
This makes it especially fast and particularly usable in LDAP
environments.  The first query is to parse global options (see
below).  The second is to match against the user's name and the
groups that the user belongs to.  (The special ALL tag is matched
in this query too.)  If no match is returned for the user's name
and groups, a third query returns all entries contain user netgroups
and checks to see if the user belongs to any of them.

=item *

B<sudo> no longer exits if there is a typo in I<sudoers>.
It is not possible to load LDAP data into the server that does
not conform to the sudoers schema, so proper syntax is guaranteed.
It is still possible to have typos in a user or host name, but
this will not prevent B<sudo> from running.

=item *

Options inside of entries now override global default options.
F</etc/sudoers> only supports default options and limited options
associated with user/host/commands and aliases.  The syntax is
complicated and can be difficult for users to understand.

Sudo first looks for an entry called C<cn=default> in the C<SUDOers>
container.  If found, the multi-valued C<sudoOption> attribute is
parsed the same way the global C<Defaults> line in F</etc/sudoers>
is parsed.

If, on the second or third query, a response contains a sudoRole
which matches against the user, host, and command, then the matched
object is scanned for a additional options that override the top-level
defaults.  See the example LDAP content below for more information.

=item *

B<visudo> is no longer needed.  B<visudo> provides locking and
syntax checking of the F</etc/sudoers> file.  Since LDAP updates
are atomic, locking is no longer necessary.  Because syntax is
checked when the data is inserted into LDAP, there is no need
for a specialized tool to check syntax.

=item *

Aliases are no longer needed.  User, Host, and Cmnd Aliases were
designed to simplify organization of I<sudoers> files and to
improve readability.  Since an LDAP I<sudoers> entry allows multiple
values for each of its attributes, and since most LDAP browsers are
graphical and easy to work with, these aliases are no longer
needed.

If you wish to specify a large number of users into an entry or
wish to have similar entries with identical users, then either use
groups or user netgroups.  Alternately, they can all just be pasted
into the LDAP record.

If you need to specify a large number of hosts in an entry, use
netgroups or IP address matches (10.2.3.4/255.255.0.0).  Alternately,
they can all just be pasted into the LDAP record.

=back

=head2 Differences between LDAP and non-LDAP sudoers

There are some subtle differences in the way sudoers is handled
once in LDAP.  Probably the biggest is that according to the RFC,
LDAP's ordering is arbitrary and you cannot expect that Attributes
and Entries are returned in any order.  If there are conflicting
command rules on an entry, the negative takes precedence.  This is
called paranoid behavior (not necessarily the most specific match).

Here is an example:

  # /etc/sudoers:
  # Allow all commands except shell
  johnny  ALL=(root) ALL,!/bin/sh
  # Always allows all commands because ALL is matched last
  puddles ALL=(root) !/bin/sh,ALL

  # LDAP equivalent of Johnny
  # Allows all commands except shell
  dn: cn=role1,ou=Sudoers,dc=my-domain,dc=com
  objectClass: sudoRole
  objectClass: top
  cn: role1
  sudoUser: johnny
  sudoHost: ALL
  sudoCommand: ALL
  sudoCommand: !/bin/sh

  # LDAP equivalent of Puddles
  # Notice that even though ALL comes last, it still behaves like
  # role1 since the LDAP code assumes the more paranoid configuration
  dn: cn=role2,ou=Sudoers,dc=my-domain,dc=com
  objectClass: sudoRole
  objectClass: top
  cn: role2
  sudoUser: puddles
  sudoHost: ALL
  sudoCommand: !/bin/sh
  sudoCommand: ALL

Another difference is that negations on the Host, User or Runas are
currently ignorred.  For example, the following attributes do not
do what they might appear to do.

  # does not match all but joe
  # rather, does not match anyone
  sudoUser: !joe

  # does not match all but joe
  # rather, matches everyone including Joe
  sudoUser: ALL
  sudoUser: !joe

  # does not match all but web01
  # rather, matches all hosts including web01
  sudoHost: ALL
  sudoHost: !web01

=head2 Description of sudoRole

The equivalent of a sudoer in LDAP is a 'sudoRole'.  It contains
sudoUser(s), sudoHost, sudoCommand and optional sudoOption(s),
sudoRunAsUser(s) and sudoRunAsGroup(s).

The following example allows users in group wheel to run any command
on any host via B<sudo>:

 dn: cn=%wheel,ou=SUDOers,dc=example,dc=com
 objectClass: top
 objectClass: sudoRole
 cn: %wheel
 sudoUser: %wheel
 sudoHost: ALL
 sudoCommand: ALL

=head2 Sudoers Schema

In order to use B<sudo>'s LDAP support the B<sudo> schema must be
installled on your LDAP server.  In addition, be sure to index the
attribute 'sudoUser'.

Two versions of the schema, one for OpenLDAP servers and another
for netscape-derived servers, may also be found in the B<sudo>
distribution.  The schema for B<sudo> in OpenLDAP form appears
below.

 attributetype ( 1.3.6.1.4.1.15953.9.1.1
    NAME 'sudoUser'
    DESC 'User(s) who may  run sudo'
    EQUALITY caseExactIA5Match
    SUBSTR caseExactIA5SubstringsMatch
    SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )

 attributetype ( 1.3.6.1.4.1.15953.9.1.2
    NAME 'sudoHost'
    DESC 'Host(s) who may run sudo'
    EQUALITY caseExactIA5Match
    SUBSTR caseExactIA5SubstringsMatch
    SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )

 attributetype ( 1.3.6.1.4.1.15953.9.1.3
    NAME 'sudoCommand'
    DESC 'Command(s) to be executed by sudo'
    EQUALITY caseExactIA5Match
    SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )

 attributetype ( 1.3.6.1.4.1.15953.9.1.4
    NAME 'sudoRunAs'
    DESC 'User(s) impersonated by sudo'
    EQUALITY caseExactIA5Match
    SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )

 attributetype ( 1.3.6.1.4.1.15953.9.1.5
    NAME 'sudoOption'
    DESC 'Options(s) followed by sudo'
    EQUALITY caseExactIA5Match
    SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )

 attributetype ( 1.3.6.1.4.1.15953.9.1.6
    NAME 'sudoRunAsUser'
    DESC 'User(s) impersonated by sudo'
    EQUALITY caseExactIA5Match
    SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )

 attributetype ( 1.3.6.1.4.1.15953.9.1.7
    NAME 'sudoRunAsGroup'
    DESC 'Group(s) impersonated by sudo'
    EQUALITY caseExactIA5Match
    SYNTAX 1.3.6.1.4.1.1466.115.121.1.26 )

 objectclass ( 1.3.6.1.4.1.15953.9.2.1 NAME 'sudoRole' SUP top STRUCTURAL
    DESC 'Sudoer Entries'
    MUST ( cn )
    MAY ( sudoUser $ sudoHost $ sudoCommand $ sudoRunAs $ sudoRunAsUser $
	  sudoRunAsGroup $ sudoOption $ description )
    )

=head2 Configuring ldap.conf

Sudo reads the F</etc/ldap.conf> file for LDAP-specific configuration.
Typically, this file is shared amongst different LDAP-aware clients.
As such, most of the settings are not B<sudo>-specific.  Note that
B<sudo> parses F</etc/ldap.conf> itself and may support options
that differ from those described in the L<ldap.conf(4)> manual.

Also note that on systems using the OpenLDAP libraries, default
values specified in F</etc/openldap/ldap.conf> or the user's
F<.ldaprc> files are not used.

Only those options explicitly listed in F</etc/ldap.conf> that are
supported by B<sudo> are honored.  Configuration options are listed
below in upper case but are parsed in a case-independent manner.

=over 4

=item URI ldap[s]://[hostname[:port]] ...

Specifies a whitespace-delimited list of one or more URIs describing
the LDAP server(s) to connect to.  The I<protocol> may be either B<ldap>
or B<ldaps>, the latter being for servers that support TLS (SSL)
encryption.  If no I<port> is specified, the default is port 389 for
C<ldap://> or port 636 for C<ldaps://>.  If no I<hostname> is specified,
B<sudo> will connect to B<localhost>.  Only systems using the OpenSSL
libraries support the mixing of C<ldap://> and C<ldaps://> URIs.
The netscape-derived libraries used on most commercial versions of
Unix are only capable of supporting one or the other.

=item HOST name[:port] ...

If no B<URI> is specified, the B<HOST> parameter specifies a
whitespace-delimited list of LDAP servers to connect to.  Each host
may include an optional I<port> separated by a colon (':').  The
B<HOST> parameter is deprecated in favor of the B<URI> specification
and is included for backwards compatibility.

=item PORT port_number

If no B<URI> is specified, the B<PORT> parameter specifies the
default port to connect to on the LDAP server if a B<HOST> parameter
does not specify the port itself.  If no B<PORT> parameter is used,
the default is port 389 for LDAP and port 636 for LDAP over TLS
(SSL).  The B<PORT> parameter is deprecated in favor of the B<URI>
specification and is included for backwards compatibility.

=item BIND_TIMELIMIT seconds

The B<BIND_TIMELIMIT> parameter specifies the amount of time, in seconds,
to wait while trying to connect to an LDAP server.  If multiple B<URI>s or
B<HOST>s are specified, this is the amount of time to wait before trying
the next one in the list.

=item SUDOERS_BASE base

The base DN to use when performing B<sudo> LDAP lookups.  Typically
this is of the form C<ou=SUDOers,dc=example,dc=com> for the domain
C<example.com>.

=item SUDOERS_DEBUG debug_level

This sets the debug level for B<sudo> LDAP lookups.  Debuging
information is printed to the standard error.  A value of 1 results
in a moderate amount of debugging information.  A value of 2 shows
the results of the matches themselves.  This parameter should not
be set in a production environment as the extra information is
likely to confuse users.

=item BINDDN DN

The B<BINDDN> parameter specifies the identity, in the form of a
Distinguished Name (DN), to use when performing LDAP operations.
If not specified, LDAP operations are performed with an anonymous
identity.  By default, most LDAP servers will allow anonymous access.

=item BINDPW secret

The B<BINDPW> parameter specifies the password to use when performing
LDAP operations.  This is typically used in conjunction with the
B<BINDDN> parameter.

=item ROOTBINDDN DN

The B<ROOTBINDDN> parameter specifies the identity, in the form of
a Distinguished Name (DN), to use when performing privileged LDAP
operations, such as I<sudoers> lookups.  The password corresponding
to the identity should be stored in </etc/ldap.passwd>
If not specified, the B<BINDDN> identity is used (if any).

=item LDAP_VERSION number

The version of the LDAP protocol to use when connecting to the server.
The default value is protocol version 3.

=item SSL on/true/yes/off/false/no

If the B<SSL> parameter is set to C<on>, C<true> or C<yes>, TLS
(SSL) encryption is always used when communicating with the LDAP
server.  Typically, this involves connecting to the server on port
636 (ldaps).

=item SSL start_tls

If the B<SSL> parameter is set to C<start_tls>, the LDAP server
connection is initiated normally and TLS encryption is begun before
the bind credentials are sent.  This has the advantage of not
requiring a dedicated port for encrypted communications.  This
parameter is only supported by LDAP servers that honor the C<start_tls>
extension, such as the OpenLDAP server.

=item TLS_CHECKPEER on/true/yes/off/false/no

If enabled, B<TLS_CHECKPEER> will cause the LDAP server's TLS
certificated to be verified.  If the server's TLS certificate cannot
be verified (usually because it is signed by an unknown certificate
authority), B<sudo> will be unable to connect to it.  If B<TLS_CHECKPEER>
is disabled, no check is made.

=item TLS_CACERTFILE

=item TLS_CACERTDIR

=item TLS_RANDFILE

=item TLS_CIPHERS

=item TLS_CERT

=item TLS_KEY

=item USE_SASL

=item SASL_AUTH_ID

=item ROOTUSE_SASL

=item ROOTSASL_AUTH_ID

=item SASL_SECPROPS

=item KRB5_CCNAME

=back

=head2 Configuring nsswitch.conf

Sudo consults the Name Service Switch file, F</etc/nsswitch.conf>,
to specify the I<sudoers> search order.  Sudo looks for a line
begining with C<sudoers:> and uses this to determine the search
order.  Note that B<sudo> does not stop searching after the first
match and later matches take precedence over earlier ones.

The following sources are recognized.
    files	read sudoers from a file (usually F</etc/sudoers>)
    ldap	read sudoers from LDAP

In addition, the entry C<[NOTFOUND=return]> will short-circuit the
search if the user was not found in the preceding source.

To consult LDAP first followed by the local sudoers file (if it
exists), use:

    sudoers: ldap files

The local I<sudoers> file can be ignored completely by using:

    sudoers: ldap

If the F</etc/nsswitch.conf> file is not present or there is no
sudoers line, the following default is assumed:

    sudoers: files

=head1 FILES

=over 24

=item F</etc/ldap.conf>

LDAP configuration file

=item F</etc/nsswitch.conf>

determines sudoers source order

=back

=head1 EXAMPLES

Example entries

Example ldap.conf

Debugging info

=head1 SEE ALSO

L<ldap.conf(4)>, L<sudoers(4)>

=head1 CAVEATS

parsing differences between LDAP and file sudoers

=head1 BUGS

If you feel you have found a bug in B<sudo>, please submit a bug report
at http://www.sudo.ws/sudo/bugs/

=head1 SUPPORT

Limited free support is available via the sudo-users mailing list,
see http://www.sudo.ws/mailman/listinfo/sudo-users to subscribe or
search the archives.

=head1 DISCLAIMER

B<sudo> is provided ``AS IS'' and any express or implied warranties,
including, but not limited to, the implied warranties of merchantability
and fitness for a particular purpose are disclaimed.  See the LICENSE
file distributed with B<sudo> or http://www.sudo.ws/sudo/license.html
for complete details.
